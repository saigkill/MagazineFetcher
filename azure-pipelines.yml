trigger:
  branches:
    include:
      - master
      - develop
      - feature/*
  tags:
    include:
      - 'v*'

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: UseDotNet@2
  inputs:
    packageType: 'sdk'
    version: '9.x'

- task: AdvancedSecurity-Codeql-Init@1
  inputs:
    languages: 'csharp'
    querysuite: 'security-and-quality'
  displayName: 'Initialize CodeQL'

- task: DotNetCoreCLI@2
  inputs:
    azureSubscription: 'Nutzungsbasierte Bezahlung (7872a12f-66bb-46b3-8b12-edfaa181e48c)'
    command: 'publish'
    publishWebProjects: false
    projects: '**/*.csproj'
    arguments: '--configuration $(BuildConfiguration) --output $(Build.ArtifactStagingDirectory)/MagazineFetcher'
  displayName: 'Publish Console App'

- task: DotNetCoreCLI@2
  inputs:
    azureSubscription: 'Nutzungsbasierte Bezahlung (7872a12f-66bb-46b3-8b12-edfaa181e48c)'
    command: 'test'
    projects: '**/*[Tt]est*/*.csproj'
    arguments: '--collect:"XPlat Code Coverage" --logger:junit /p:CollectCoverage=true /p:CoverletOutputFormat=cobertura'
    testRunTitle: 'dotnet test'
  displayName: 'Run Unit Tests'

- task: AdvancedSecurity-Codeql-Analyze@1
  displayName: Perform CodeQL analysis

- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: '**/TestResults/TestResults.xml'
    testRunTitle: 'Run Testresults'
  displayName: 'Publish Test Results'

- task: PublishCodeCoverageResults@2
  inputs:
    summaryFileLocation: '$(Build.SourcesDirectory)/**/coverage.cobertura.xml'
    pathToSources: '$(System.DefaultWorkingDirectory)/**/coverage'
  displayName: 'Publish Code Coverage Results'

- task: reportgenerator@5
  inputs:
    reports: '$(Build.SourcesDirectory)/**/coverage.cobertura.xml'
    targetdir: '$(Build.SourcesDirectory)/CodeCoverage'
  displayName: 'Generate Code Coverage Report'

- task: AdvancedSecurity-Publish@1
  displayName: Perform CodeQL analysis

- task: Bash@3
  inputs:
    targetType: 'inline'
    script: |
      DIR="MagazineFetcher"
      
      if [ -d "$DIR" ]; then
          rm -rf "$DIR"
          echo "Das Verzeichnis '$DIR' wurde gel√∂scht."
      else
          echo "Das Verzeichnis '$DIR' existiert nicht."
      fi
      
      git clone --mirror https://saigkill:$AzurePAT@dev.azure.com/saigkill/$DIR/_git/$DIR ./$DIR --verbose
      cd $DIR
      git remote add github https://saigkill:$GithubPAT@github.com/saigkill/$DIR.git
      git push github --mirror

- task: ArchiveFiles@2
  condition: eq(variables['PipelineType'], 'prod')
  inputs:
    rootFolderOrFile: '$(Build.ArtifactStagingDirectory)/MagazineFetcher'
    includeRootFolder: false
    archiveType: 'zip'
    archiveFile: '$(Build.ArtifactStagingDirectory)/MagazineFetcher.zip'
    replaceExistingArchive: true
  displayName: 'Create ZIP'

- task: GitHubRelease@1
  condition: eq(variables['PipelineType'], 'prod')
  inputs:
    gitHubConnection: 'github.com_saigkill'
    repositoryName: 'saigkill/MagazineFetcher'
    action: 'create'
    target: '$(Build.SourceVersion)'
    tagSource: 'gitTag'
    assets: '$(Build.ArtifactStagingDirectory)/MagazineFetcher.zip'
    title: 'Release $(Build.SourceBranchName)'
    isDraft: false
    isPreRelease: false
  displayName: 'Create GitHub Release'
