trigger:
  branches:
    include:
      - master
      - develop
      - feature/*
  tags:
    include:
      - 'v*'

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: UseDotNet@2
  inputs:
    packageType: 'sdk'
    version: '9.x'

- task: AdvancedSecurity-Codeql-Init@1
  inputs:
    languages: 'csharp'
    querysuite: 'security-and-quality'

- task: DotNetCoreCLI@2
  inputs:
    command: 'build'
    projects: 'MagazineFetcher/MagazineFetcher.csproj'
    arguments: '--configuration Release'
  displayName: 'Build Console App'

- task: AdvancedSecurity-Codeql-Analyze@1
  inputs:

- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: '**/TestResults/TestResults.xml'
    testRunTitle: 'Run Testresults'

- task: PublishCodeCoverageResults@2
  inputs:
    summaryFileLocation: '$(Build.SourcesDirectory)/**/coverage.*.cobertura.xml'
    pathToSources: '$(System.DefaultWorkingDirectory)/**/coverage'

- task: reportgenerator@5
  inputs:
    reports: '$(Build.SourcesDirectory)/**/coverage.*.cobertura.xml'
    targetdir: '$(Build.SourcesDirectory)/CodeCoverage'

- task: AdvancedSecurity-Publish@1
  inputs:

- task: ArchiveFiles@2
  condition: eq(variables['PipelineType'], 'prod')
  inputs:
    rootFolderOrFile: 'MagazineFetcher/bin/Release/net9.0'
    includeRootFolder: false
    archiveType: 'zip'
    archiveFile: '$(Build.ArtifactStagingDirectory)/MagazineFetcher.zip'
    replaceExistingArchive: true
  displayName: 'Create ZIP'

- task: GitHubRelease@1
  condition: eq(variables['PipelineType'], 'prod')
  inputs:
    gitHubConnection: 'github.com_saigkill'
    repositoryName: 'saigkill/MagazineFetcher'
    action: 'create'
    target: '$(Build.SourceVersion)'
    tagSource: 'gitTag'
    assets: '$(Build.ArtifactStagingDirectory)/MagazineFetcher.zip'
    title: 'Release $(Build.SourceBranchName)'
    isDraft: false
    isPreRelease: false
  displayName: 'Create GitHub Release'
